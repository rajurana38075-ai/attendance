<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Waheguru Attendance (OTP, Multi, Share)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      --skyblue: #e3f2fd; --darkblue: #1565c0;
      --gradient: linear-gradient(135deg,#64b5f6 0%,#1976d2 100%);
    }
    body {background:var(--gradient); font-family:'Segoe UI',sans-serif; margin:0; color:#102447;}
    .container {max-width:400px;background:var(--skyblue);margin:30px auto 0 auto;border-radius:18px;box-shadow:0 8px 24px rgba(21,101,192,0.17);padding:23px 10px 10px 10px;}
    .header {text-align:center;}
    .header h1 {color:var(--darkblue);font-size:2em;font-weight:700;margin-bottom:2px;}
    .header h2 {font-size:1.08em;color:#102447;margin-bottom:9px;font-weight:500;}
    .otp-screen {text-align:center;}
    .otp-label {font-size:1em;font-weight:500;color:var(--darkblue);}
    .otp-btn {background:var(--darkblue);color:#fff;border:none;border-radius:7px;padding:9px 22px;font-size:1em;font-weight:600;cursor:pointer;margin:7px 2px;}
    .otp-input {width:110px;padding:9px;font-size:1.1em;border-radius:8px;border:1.6px solid #bdbdbd;outline:none;text-align:center;}
    .otp-error {color:red;margin-top:7px;font-size:0.97em;min-height:1.2em;}
    .show-otp-txt{background:#fff2; color:#1976d2;border-radius:10px;padding:6px 14px;font-size:1.09em;margin:5px 0 8px 0;font-weight:600;letter-spacing:1px;display:inline-block;}
    .hide{display:none!important;}
    .otp-msg{font-size:0.94em;color:#1565c0d6;}
    .emp-list {margin:10px 0;}
    .emp-row {display:flex;align-items:center;gap:7px;background:#bbdefb;border-radius:7px;padding:7px 5px;margin-bottom:8px;}
    .emp-name {flex:1;font-weight:500;}
    .emp-btn {padding:7px 13px;font-size:0.99em;background:#1565c0;color:#fff;border:none;border-radius:6px;cursor:pointer;}
    .emp-btn[disabled]{background:#b0b0b0;cursor:not-allowed;}
    .log {margin-top:10px;background:#e1f5fe;border-radius:7px;padding:8px 5px;font-size:1em;max-height:170px;overflow-y:auto;}
    .log-table{width:100%;border-collapse:collapse;}
    .log-table th,.log-table td{padding:4px 7px;border-bottom:1px solid #90caf9;font-size:0.97em;}
    .log-table th{background:#82b1ff;color:#102447;font-weight:600;}
    .btn-row{display:flex;gap:8px;margin-top:13px;justify-content:center;}
    .whatsapp-btn,.download-btn{flex:1;padding:10px;border-radius:7px;font-size:1em;font-weight:500;cursor:pointer;border:none;margin-bottom:5px;box-shadow:0 0.5px 3px #aaa2;}
    .whatsapp-btn{background:#25D366;color:#fff;}
    .download-btn{background:#1976d2;color:#fff;}
    @media (max-width:440px){.container{max-width:98vw;margin:10px;}.header h1{font-size:1.18em;}}
    .modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:#0006;display:flex;align-items:center;justify-content:center;z-index:50;}
    .modal-box{background:#fff;border-radius:10px;padding:22px 17px 16px 17px;min-width:210px;text-align:center;box-shadow:0 2px 25px #1976d245;}
    .modal-inp{padding:9px;font-size:1.13em;border-radius:6px;width:120px;margin-bottom:10px;letter-spacing:3px;text-align:center;border:1.1px solid #1565c0;}
    .modal-btn{background:#1976d2;color:#fff;padding:9px 24px;border:none;border-radius:6px;font-weight:600;font-size:1.08em;}
    .modal-err{color:#f33;min-height:1em;}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Waheguru Attendance</h1>
    <h2 id="dateDay"></h2>
  </div>

  <!-- OTP Screen -->
  <div class="otp-screen" id="otpBlock">
    <label class="otp-label">‡§Ü‡§ú ‡§ï‡§æ OTP ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç:</label><br>
    <div class="otp-msg">(Request OTP ‡§¨‡§ü‡§® ‡§∏‡•á code ‡§™‡§æ‡§è‡§Å, admin ‡§∏‡•á ‡§™‡•Ç‡§õ‡•á‡§Ç)</div>
    <button class="otp-btn" id="reqOTPBtn" type="button" onclick="otpRequestFlow()" style="margin-top:7px;">Request OTP</button>
    <div id="otpDisplay" class="show-otp-txt hide"></div>
    <input type="text" class="otp-input" id="otpInput" maxlength="6" placeholder="OTP">
    <button class="otp-btn" onclick="checkOTP()">Verify</button>
    <div class="otp-error" id="otpError"></div>
  </div>

  <!-- Attendance Form (Multi employee, hide until correct OTP) -->
  <div id="attendanceForm" style="display:none;">
    <div class="info" style="margin-bottom:7px;">‡§®‡•Ä‡§ö‡•á ‡§∏‡§≠‡•Ä ‡§™‡§∞ Attendance ‡§ï‡§∞‡•á‡§Ç:<br>
      <button class="otp-btn" id="reqOTPBtn2" type="button" style="padding:7px 14px 6px 14px;margin:8px 0;" onclick="otpRequestFlow()">Request OTP</button>
    </div>
    <div id="formOTPDisplay" class="show-otp-txt hide" style="margin-top:3px;"></div>
    <div class="emp-list" id="empList"></div>
    <div class="log" id="attendanceLog" style="display:none;">
      <table class="log-table" id="logTable">
        <thead><tr><th>‡§®‡§æ‡§Æ</th><th>‡§∏‡§Æ‡§Ø</th><th>‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï</th><th>‡§¶‡§ø‡§®</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="btn-row">
      <button class="whatsapp-btn" id="whatsappShare">WhatsApp ‡§™‡§∞ ‡§∂‡•á‡§Ø‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
      <button class="download-btn" id="downloadExcel">Excel (CSV) ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
      <button class="download-btn" id="clearDayData" style="background:#ef5350;">‡§Ü‡§ú ‡§ï‡§æ data ‡§π‡§ü‡§æ‡§è‡§Å</button>
    </div>
  </div>

  <!-- Password Modal -->
  <div id="modalBG" class="modal-bg hide">
    <div class="modal-box">
      <div style="font-size:1.1em;font-weight:500;margin-bottom:5px;color:#1976d2;">Request OTP<br>‡§™‡§π‡•Å‡§Å‡§ö ‡§™‡§æ‡§®‡•á ‡§π‡•á‡§§‡•Å ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§°‡§æ‡§≤‡•á‡§Ç</div>
      <input id="modalPass" class="modal-inp" type="password" maxlength="6" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°" autofocus>
      <div class="modal-err" id="modalError"></div>
      <button class="modal-btn" onclick="modalSubmit()">OK</button>
    </div>
  </div>
</div>

<script>
function nowDateStr() {
  let n = new Date();
  return n.toLocaleDateString('hi-IN');
}
function nowDayStr() {
  let n = new Date();
  return n.toLocaleDateString('hi-IN', {weekday:'long'});
}
function nowTimeStr() {
  let n = new Date();
  return n.toLocaleTimeString('hi-IN');
}
function updateDateDay() {
  let now = new Date();
  let day = nowDayStr();
  let date = nowDateStr();
  document.getElementById("dateDay").innerText = "‡§¶‡§ø‡§®: "+day+" | ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: "+date;
}
updateDateDay();

// OTP logic (auto, daily)
function makeOTP() {
  let n = new Date();
  let dd = n.getDate();
  let mm = n.getMonth()+1;
  let yyyy = n.getFullYear();
  let otp = (dd * mm + yyyy) % 100000 + 21;
  return String(otp).padStart(6,'0');
}
const todaysOTP = makeOTP();
const PASSWORD = "0703";

let currentOTPDiv = null;
function otpRequestFlow() {
  currentOTPDiv = (document.getElementById('attendanceForm').style.display=="none") 
    ? document.getElementById("otpDisplay") : document.getElementById("formOTPDisplay");
  document.getElementById("modalError").textContent = "";
  document.getElementById("modalBG").classList.remove("hide");
  document.getElementById("modalPass").value = "";
  setTimeout(() => document.getElementById("modalPass").focus(),100);
}
function modalSubmit() {
  let pass = document.getElementById("modalPass").value.trim();
  if(pass === PASSWORD) {
    document.getElementById("modalBG").classList.add("hide");
    showOTPdiv();
  } else {
    document.getElementById("modalError").textContent = "‚ùå ‡§ó‡§≤‡§§ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°!";
  }
}
document.getElementById("modalPass").addEventListener("keydown",function(e){
  if(e.key==="Enter")modalSubmit();
});
// OTP show for 60s
function showOTPdiv() {
  if(!currentOTPDiv) return;
  currentOTPDiv.textContent = "OTP: " + todaysOTP;
  currentOTPDiv.classList.remove("hide");
  setTimeout(function(){
    currentOTPDiv.classList.add("hide");
  }, 60000); // 60 sec
  currentOTPDiv = null;
}

// Employee list (edit as needed)
let employees = [
  "Prem","Dev","Banti","Sorabh","Ankit","Bilal Khan","Arbaz Khan","Sahil","love","Raju"
];
const DATA_KEY = "wgAtt_" + nowDateStr();
let attRows = JSON.parse(localStorage.getItem(DATA_KEY) || '[]');

function renderEmpList() {
  let html = '';
  employees.forEach((name,i)=>{
    let done = attRows.find(r=>r.‡§®‡§æ‡§Æ===name);
    html += `<div class="emp-row" id="row${i}">
      <div class="emp-name">${name}</div>
      <button class="emp-btn" onclick="markAttendance('${name}',${i})" id="btn${i}"${done?' disabled':''}>
      ${done?'‚úì Marked':'Attendance'}
      </button>
    </div>`;
  });
  document.getElementById("empList").innerHTML = html;
  showAttLog();
}
function showAttLog() {
  let logDiv = document.getElementById('attendanceLog');
  let logTable = document.getElementById('logTable').getElementsByTagName('tbody')[0];
  logTable.innerHTML = "";
  attRows.forEach(row => {
    logTable.innerHTML += `<tr>
      <td>${row.‡§®‡§æ‡§Æ}</td>
      <td>${row.‡§ü‡§æ‡§á‡§Æ}</td>
      <td>${row.‡§§‡§æ‡§∞‡•Ä‡§ñ}</td>
      <td>${row.‡§¶‡§ø‡§®}</td>
    </tr>`;
  });
  logDiv.style.display = attRows.length ? "block" : "none";
}

// OTP Verify (attendance ‡§ñ‡•ã‡§≤‡§®‡§æ)
function checkOTP() {
  let inp = document.getElementById('otpInput').value.trim();
  let err = document.getElementById('otpError');
  if(inp === todaysOTP) {
    document.getElementById('otpBlock').style.display = "none";
    document.getElementById('attendanceForm').style.display = "";
    err.textContent = "";
    renderEmpList();
  } else {
    err.textContent = "‡§ó‡§≤‡§§ OTP! ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§π‡•Ä OTP ‡§°‡§æ‡§≤‡•á‡§Ç‡•§";
  }
}

// WhatsApp share
document.getElementById('whatsappShare').onclick = function() {
  let text = `üôè Waheguru Attendance\n‡§¶‡§ø‡§®: ${nowDayStr()} | ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï: ${nowDateStr()}\n`;
  attRows.forEach((row,i)=>{
    text += `${i+1}) ${row.‡§®‡§æ‡§Æ} - ${row.‡§ü‡§æ‡§á‡§Æ}\n`;
  });
  window.open(`https://wa.me/?text=` + encodeURIComponent(text), "_blank");
};
// Excel Download
document.getElementById('downloadExcel').onclick = function() {
  let csv = "‡§®‡§æ‡§Æ,‡§∏‡§Æ‡§Ø,‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï,‡§¶‡§ø‡§®\n";
  attRows.forEach(row=>{
    csv += `"${row.‡§®‡§æ‡§Æ}","${row.‡§ü‡§æ‡§á‡§Æ}","${row.‡§§‡§æ‡§∞‡•Ä‡§ñ}","${row.‡§¶‡§ø‡§®}"\n`;
  });
  let blob = new Blob([csv], {type:'text/csv'});
  let a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "Attendance-"+nowDateStr()+".csv";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
};
// Today clear data
document.getElementById('clearDayData').onclick = function() {
  if(confirm("‡§Ü‡§ú ‡§ï‡•Ä attendance data ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç? (Undo possible ‡§®‡§π‡•Ä‡§Ç)")) {
    attRows=[]; localStorage.removeItem(DATA_KEY);
    renderEmpList(); showAttLog();
    document.getElementById('whatsappShare').style.display='none';
    document.getElementById('downloadExcel').style.display='none';
    document.getElementById('clearDayData').style.display='none';
  }
};

// Google Sheets ‡§Æ‡•á‡§Ç attendance ‡§≠‡•á‡§ú‡§®‡§æ (API ‡§≤‡§ø‡§Ç‡§ï ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§°‡§æ‡§≤‡•á‡§Ç)
// Google Sheets ‡§Æ‡•á‡§Ç attendance ‡§≠‡•á‡§ú‡§®‡§æ (API ‡§≤‡§ø‡§Ç‡§ï updated)
async function sendAttendanceToSheet(name, time, date, day) {
  try {
    const response = await fetch(
      'https://script.google.com/macros/s/AKfycbxsub1bNomcx0xwOHn5iviI1ya9bWwDOn_q3gyl6h1OCqfUIVrFm1d90sTwHftlqhf7yw/exec',
      {
        method: "POST",
        body: JSON.stringify({ name, time, date, day }),
        headers: {
          "Content-Type": "application/json",
          "Accept": "text/plain"
        }
      }
    );
    const result = await response.text();
    console.log('Google Sheet response:', result);
  } catch (error) {
    console.error('Error sending attendance to Google Sheet:', error);
  }
}


window.markAttendance = function(name, idx) {
  let btn = document.getElementById('btn' + idx);
  if (btn.disabled) return;

  let date = nowDateStr();
  let day = nowDayStr();
  let time = nowTimeStr();

  attRows.push({ ‡§®‡§æ‡§Æ: name, ‡§ü‡§æ‡§á‡§Æ: time, ‡§§‡§æ‡§∞‡•Ä‡§ñ: date, ‡§¶‡§ø‡§®: day });
  localStorage.setItem(DATA_KEY, JSON.stringify(attRows));

  btn.textContent = "‚úì Marked";
  btn.disabled = true;
  btn.style.background = "#b0b0b0";
  showAttLog();

  document.getElementById('whatsappShare').style.display = 'inline-block';
  document.getElementById('downloadExcel').style.display = 'inline-block';
  document.getElementById('clearDayData').style.display = 'inline-block';

  // Google Sheet ‡§Æ‡•á‡§Ç ‡§≠‡•á‡§ú‡•á (API ‡§≤‡§ø‡§Ç‡§ï ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç)
  sendAttendanceToSheet(name, time, date, day);
};
</script>
</body>
</html>

